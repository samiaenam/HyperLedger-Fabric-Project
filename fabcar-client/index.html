<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="./styles.css">

    <title>Property Tracker Hyperledger Fabric</title>
</head>

<body>
  <div class="text-center">
    <h1>Property Tracker</h1>

    <button onclick="getAll()">View All</button>
    <span> | </span>
    <input id="id-input" type="text" placeholder="Search by ID (e.g., PROP0)" />
    <button onclick="searchById()">Search ID</button>
    <span> | </span>
    <input id="city-input" type="text" placeholder="Search by City (e.g., Dhaka)" />
    <button onclick="searchByCity()">Search City</button>

    <div id="show-list"></div>
  </div>

  <div class="text-center form-container">
    <h3>Create Property</h3>
    <form id="createForm" name="createProperty">
      <div><label>ID</label><input name="id" /></div>
      <div><label>Address</label><input name="address" /></div>
      <div><label>City</label><input name="city" /></div>
      <div><label>Size</label><input name="property_size" /></div>
      <div><label>Owner</label><input name="owner_name" /></div>
      <div><label>Type</label><input name="property_type" /></div>
      <div><button type="submit">Create</button></div>
    </form>
  </div>

  <div class="text-center form-container">
    <h3>Update Property (partial)</h3>
    <form id="updateForm" name="updateProperty">
      <div><label>ID</label><input name="id" required /></div>
      <div><label>Address</label><input name="address" /></div>
      <div><label>City</label><input name="city" /></div>
      <div><label>Size</label><input name="property_size" /></div>
      <div><label>Owner</label><input name="owner_name" /></div>
      <div><label>Type</label><input name="property_type" /></div>
      <div><button type="submit">Update</button></div>
    </form>
  </div>

  <script>
    const API = 'http://localhost:3000';

    // create
    document.getElementById('createForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const body = new URLSearchParams(new FormData(e.target));
      fetch(`${API}/properties`, { method: 'POST', body })
        .then(r => r.json())
        //.then(j => { alert(j.message || 'Created'); getAll(); })
                .then(j => { alert(j.message || 'Created'); })

        .catch(err => alert(err.message));
    });

    // update (partial)
    document.getElementById('updateForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const body = new URLSearchParams(new FormData(e.target));
      fetch(`${API}/properties`, { method: 'PATCH', body })
        .then(r => r.json())
        .then(j => { alert(j.message || 'Updated'); getAll(); })
        .catch(err => alert(err.message));
    });

    function searchById() {
      const id = document.getElementById('id-input').value;
      if (!id) return;
      fetch(`${API}/properties?id=${encodeURIComponent(id)}`)
        .then(r => r.json())
        .then(renderList)
        .catch(() => alert('Search failed'));
    }

    function searchByCity() {
      const city = document.getElementById('city-input').value;
      if (!city) return;
      fetch(`${API}/properties?city=${encodeURIComponent(city)}`)
        .then(r => r.json())
        .then(renderList)
        .catch(() => alert('Search failed'));
    }

    function getAll() {
      fetch(`${API}/properties`)
        .then(r => r.json())
        .then(renderList)
        .catch(() => alert('Load failed'));
    }

    function renderList(list) {
      const host = document.getElementById('show-list');
      let html = '';
      (list || []).forEach(item => {
        html += `
          <div class="car-item">
            <p><b>ID:</b> ${item.Key}</p>
            <p><b>Address:</b> ${item.Record.address || ''}</p>
            <p><b>City:</b> ${item.Record.city || ''}</p>
            <p><b>Size:</b> ${item.Record.property_size || ''}</p>
            <p><b>Owner:</b> ${item.Record.owner_name || ''}</p>
            <p><b>Type:</b> ${item.Record.property_type || ''}</p>
          </div>`;
      });
      host.innerHTML = html || '<p>No data</p>';
    }
  </script>
</body>